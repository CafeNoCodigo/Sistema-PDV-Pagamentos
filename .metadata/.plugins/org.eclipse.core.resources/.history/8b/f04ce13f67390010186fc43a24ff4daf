package com.minhaloja.sistema_pagamento.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.sql.Statement;

import com.minhaloja.sistema_pagamento.model.Funcionario;
import com.minhaloja.sistema_pagamento.util.Conexao;

import javafx.scene.control.Alert;

public class FuncionarioDAO {
	
	public FuncionarioDAO() {
		criarTabelaSeNaoExistir();
	}

	private void criarTabelaSeNaoExistir() {
    	String sql = """
    		    CREATE TABLE IF NOT EXISTS funcionarios (
    		        id INT PRIMARY KEY AUTO_INCREMENT,
    		        nome VARCHAR(255) NOT NULL,
    		        bi VARCHAR(50),
    		        endereco VARCHAR(255),
    		        bairro VARCHAR(255),
    		        cidade VARCHAR(100),
    		        telefone1 DOUBLE,
    		        telefone2 DOUBLE,
    		        nuit VARCHAR(100),
    		        dataNascido DATE,
    		        cargo VARCHAR(100),
    		        contaBancaria1 VARCHAR(100),
    		        contaBancaria2 VARCHAR(100),
    		        dataInicio DATE,
    		        dataFim DATE,
    		        salario INT,
    		        alimentacao INT,
    		        transporte INT,
    		        imagemFuncionario MEDIUMBLOB,
    		        imagemBi MEDIUMBLOB,
    		        codigo DOUBLE,
    		        loja VARCHAR(100)
    		    );
    		""";

        try (Connection conn = Conexao.conectar(); Statement stmt = conn.createStatement()) {
            stmt.execute(sql);
        } catch (SQLException e) {
            System.out.println("Erro ao criar tabela: " + e.getMessage());
        }
    }
	
	public void salvarFuncionario(Funcionario funcionario) {
	    String sql = """
	        INSERT INTO funcionarios(nome, bi, endereco, bairro, cidade, telefone1, 
	        telefone2, nuit, dataNascido, cargo, contaBancaria1, contaBancaria2, dataInicio, dataFim, salario,
	        alimentacao, transporte, imagemFuncionario, imagemBi, codigo, loja) 
	        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
	    """;

	    try (Connection conn = Conexao.conectar(); PreparedStatement pstmt = conn.prepareStatement(sql)) {
	        pstmt.setString(1, funcionario.getNome());
	        pstmt.setString(2, funcionario.getNumeroBi());
	        pstmt.setString(3, funcionario.getEndereco());
	        pstmt.setString(4, funcionario.getBairro());
	        pstmt.setString(5, funcionario.getCidade());
	        pstmt.setDouble(6, funcionario.getTelefone1());
	        pstmt.setDouble(7, funcionario.getTelefone2());
	        pstmt.setString(8, funcionario.getNuit());

	        // Datas (LocalDate para java.sql.Date)
	        pstmt.setDate(9, funcionario.getDataNascido() != null ? java.sql.Date.valueOf(funcionario.getDataNascido()) : null);
	        pstmt.setString(10, funcionario.getCargo());
	        pstmt.setString(11, funcionario.getContaBancaria1());
	        pstmt.setString(12, funcionario.getContaBancaria2());
	        pstmt.setDate(13, funcionario.getDataInicio() != null ? java.sql.Date.valueOf(funcionario.getDataInicio()) : null);
	        pstmt.setDate(14, funcionario.getDataFim() != null ? java.sql.Date.valueOf(funcionario.getDataFim()) : null);
	        
	        pstmt.setInt(15, funcionario.getSalario());
	        pstmt.setInt(16, funcionario.getAlimentacao());
	        pstmt.setInt(17, funcionario.getTransporte());
	        pstmt.setBytes(18, funcionario.getImagemFuncionario());
	        pstmt.setBytes(19, funcionario.getImagemBi());
	        pstmt.setDouble(20, funcionario.getCodigo());
	        pstmt.setString(21, funcionario.getLoja());

	        pstmt.executeUpdate();

	        Alert alerta = new Alert(Alert.AlertType.INFORMATION);
	        alerta.setTitle("Sucesso");
	        alerta.setHeaderText(null);
	        alerta.setContentText("Funcionário salvo com sucesso!");
	        alerta.showAndWait();
	    } catch (SQLException e) {
	        e.printStackTrace();
	        Alert alerta = new Alert(Alert.AlertType.ERROR);
	        alerta.setTitle("Erro");
	        alerta.setHeaderText("Erro ao salvar funcionário");
	        alerta.setContentText(e.getMessage());
	        alerta.showAndWait();
	    }
	}

}
